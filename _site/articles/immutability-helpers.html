<!DOCTYPE html>
<html>

  <head>
  <title>Immutability Helpers</title>
  <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
  <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
  <meta name="description" content="© 2015 GitHub Inc. All rights reserved.
">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <link rel="stylesheet" href="/help-doc/v006/css/ui.css">
  <link rel="canonical" href="/help-doc/v006/articles/immutability-helpers.html">
  <link rel="alternate" type="application/rss+xml" title="GitHub Help" href="/feed.xml" | prepend: site.baseurl | prepend: site.url }}" />
</head>


  <body class='app'>

    <div class='header'>
  <div class='container'>
    <div class='row'>
      <div class='col-pad-12'>
        <div class='site'>
          <a href="/help-doc/v006/">
            <span class='s0'>GitHub Help</span>
            <span class='s1'>Center</span>
          </a> 
<!--
          <div class="wrapper">

            <nav class="site-nav">
              <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                  <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                  <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                  <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
              </a>

              <div class="trigger">
                
                  
                  <a class="page-link" href="/help-doc/v006/about/">About</a>
                  
                
                  
                
                  
                
                  
                  <a class="page-link" href="/help-doc/v006/search/index.html">Search</a>
                  
                
                  
                
              </div>
            </nav>

          </div>
-->
        </div>
      </div>
    </div>
  </div>
</div>



    <div class='container'>
      <div class='row'>
        <div class='sidebar col-pad-3'> 
          
  
  <div class='category'>
    <div class='name'>
      <a href="/help-doc/v006/categories/guides">Guides</a>
    </div>
    <div class='articles'>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/why-react.html">Why React?</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/displaying-data.html">Displaying Data</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
          
          <ul>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/jsx-in-depth.html">JSX in Depth</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/jsx-spread.html">JSX Spread</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/jsx-gotchas.html">JSX Gotchas</a>
    </li>
  
</ul>

        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/interactivity-and-dynamic-uis.html">Interactivity and Dynamic UIs</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/multiple-components.html">Multiple Components</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/reusable-components.html">Reusable Components</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/transferring-props.html">Transferring Props</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/forms.html">Forms</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/working-with-the-browser.html">Working with the Browser</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
          
          <ul>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/more-about-refs.html">More About Refs</a>
    </li>
  
</ul>

        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/tooling-integration.html">Tooling Integration</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/addons.html">Addons</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
          
          <ul>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/animation.html">Animation</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/two-way-binding-helpers.html">Two-Way Binding Helpers</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/class-name-manipulation.html">Class Name Manipulation</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/test-utilities.html">Test Utilities</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/cloning-reactelements.html">Cloning ReactElements</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/keyed-fragments.html">Keyed Fragments</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/immutability-helpers.html">Immutability Helpers</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/pure-render-mixin.html">Pure Render Mixin</a>
    </li>
  
    <li>
      <a class="post-link" href="/help-doc/v006/articles/performance-tools.html">Performance Tools</a>
    </li>
  
</ul>

        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
      <div class='article'>
        <a class="post-link" href="/help-doc/v006/articles/advanced-performance.html">Advanced Performance</a>
        <!-- 如果当前文章有下属的子文章，就顺便列出它们 -->
        
        
        <!-- 子文档列表功能 增加的代码部分结束 -->
      </div>
      
    </div>
  </div>


        </div>
        <div class='main col-pad-9'>

          <!-- 注意，如果发布到 github pages 时采用了 gh-pages 方式，那么下列代码中的 /search, /js 等路径需要增加 /help-doc/v006 前缀 -->
<div id="search">
  <h2>
  <form action="/help-doc/v006/search" method="get">
    <input type="text" id="search-query" name="q" placeholder="Search" autocomplete="off">
  </form>
  </h2>
</div>
<section id="search-results" style="display: none;">
  <h3>Search results</h3>
  <div class="entries">
  </div>
</section>

<script id="search-results-template" type="text/mustache">
  {{#entries}}
    <article>
      <h3>
        <a href="{{{ site.baseurl }}}{{url}}">{{title}}</a>
      </h3>
    </article>
  {{/entries}}
</script>

<script src="/help-doc/v006/js/search.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl: '/help-doc/v006/js/index.json',   // Url for the .json file containing search index data
      results : '#search-results',  // selector for containing search results element
      entries : '.entries',         // selector for search entries containing element (contained within results above)
      template: '#search-results-template'  // selector for Mustache.js template
    });
  });
</script>


          <h1>Immutability Helpers</h1>
<p></p>

<p>React lets you use whatever style of data management you want, including mutation. However, if you can use immutable data in performance-critical parts of your application it’s easy to implement a fast <code>shouldComponentUpdate()</code> method to significantly speed up your app.</p>

<p>Dealing with immutable data in JavaScript is more difficult than in languages designed for it, like <a href="http://clojure.org/">Clojure</a>. However, we’ve provided a simple immutability helper, <code>update()</code>, that makes dealing with this type of data much easier, <em>without</em> fundamentally changing how your data is represented. You can also take a look at Facebook’s <a href="https://facebook.github.io/immutable-js/docs/">Immutable-js</a> and the <a href="/react/docs/advanced-performance.html">Advanced Performance</a> section for more detail on Immutable-js.</p>

<h2 id="the-main-idea">The main idea</h2>

<p>If you mutate data like this:</p>

<p><code>js
myData.x.y.z = 7;
// or...
myData.a.b.push(9);
</code></p>

<p>you have no way of determining which data has changed since the previous copy has been overwritten. Instead, you need to create a new copy of <code>myData</code> and change only the parts of it that need to be changed. Then you can compare the old copy of <code>myData</code> with the new one in <code>shouldComponentUpdate()</code> using triple-equals:</p>

<p><code>js
var newData = deepCopy(myData);
newData.x.y.z = 7;
newData.a.b.push(9);
</code></p>

<p>Unfortunately, deep copies are expensive, and sometimes impossible. You can alleviate this by only copying objects that need to be changed and by reusing the objects that haven’t changed. Unfortunately, in today’s JavaScript this can be cumbersome:</p>

<p><code>js
var newData = extend(myData, {
  x: extend(myData.x, {
    y: extend(myData.x.y, {z: 7}),
  }),
  a: extend(myData.a, {b: myData.a.b.concat(9)})
});
</code></p>

<p>While this is fairly performant (since it only makes a shallow copy of <code>log n</code> objects and reuses the rest), it’s a big pain to write. Look at all the repetition! This is not only annoying, but also provides a large surface area for bugs.</p>

<p><code>update()</code> provides simple syntactic sugar around this pattern to make writing this code easier. This code becomes:</p>

<p><code>js
var newData = React.addons.update(myData, {
  x: {y: {z: {$set: 7}}},
  a: {b: {$push: [9]}}
});
</code></p>

<p>While the syntax takes a little getting used to (though it’s inspired by <a href="http://docs.mongodb.org/manual/core/crud-introduction/#query">MongoDB’s query language</a>) there’s no redundancy, it’s statically analyzable and it’s not much more typing than the mutative version.</p>

<p>The <code>$</code>-prefixed keys are called <em>commands</em>. The data structure they are “mutating” is called the <em>target</em>.</p>

<h2 id="available-commands">Available commands</h2>

<ul>
  <li><code>{$push: array}</code> <code>push()</code> all the items in <code>array</code> on the target.</li>
  <li><code>{$unshift: array}</code> <code>unshift()</code> all the items in <code>array</code> on the target.</li>
  <li><code>{$splice: array of arrays}</code> for each item in <code>arrays</code> call <code>splice()</code> on the target with the parameters provided by the item.</li>
  <li><code>{$set: any}</code> replace the target entirely.</li>
  <li><code>{$merge: object}</code> merge the keys of <code>object</code> with the target.</li>
  <li><code>{$apply: function}</code> passes in the current value to the function and updates it with the new returned value.</li>
</ul>

<h2 id="examples">Examples</h2>

<h3 id="simple-push">Simple push</h3>

<p><code>js
var initialArray = [1, 2, 3];
var newArray = update(initialArray, {$push: [4]}); // =&gt; [1, 2, 3, 4]
</code>
<code>initialArray</code> is still <code>[1, 2, 3]</code>.</p>

<h3 id="nested-collections">Nested collections</h3>

<p><code>js
var collection = [1, 2, {a: [12, 17, 15]}];
var newCollection = update(collection, {2: {a: {$splice: [[1, 1, 13, 14]]}}});
// =&gt; [1, 2, {a: [12, 13, 14, 15]}]
</code>
This accesses <code>collection</code>’s index <code>2</code>, key <code>a</code>, and does a splice of one item starting from index <code>1</code> (to remove <code>17</code>) while inserting <code>13</code> and <code>14</code>.</p>

<h3 id="updating-a-value-based-on-its-current-one">Updating a value based on its current one</h3>

<p><code>js
var obj = {a: 5, b: 3};
var newObj = update(obj, {b: {$apply: function(x) {return x * 2;}}});
// =&gt; {a: 5, b: 6}
// This is equivalent, but gets verbose for deeply nested collections:
var newObj2 = update(obj, {b: {$set: obj.b * 2}});
</code></p>

<h3 id="shallow-merge">(Shallow) merge</h3>

<p><code>js
var obj = {a: 5, b: 3};
var newObj = update(obj, {$merge: {b: 6, c: 7}}); // =&gt; {a: 5, b: 6, c: 7}
</code></p>



  
  <h2>
    prev post: <a href='/help-doc/v006/articles/create-fragment.html'>create-fragment.html</a>
  </h2>


  
  <h2>
    next post: <a href='/help-doc/v006/articles/pure-render-mixin.html'>pure-render-mixin.html</a>
  </h2>




        </div>

      </div>
      <div class='row'>

        <div class='team'>GitHub Help</div>
<a class='link' href='mailto:support@github.com' target='_blank'>support@github.com</a>
<div class="footer-col  footer-col-3">
  <p class="text">© 2015 GitHub Inc. All rights reserved.
</p>
</div>


      </div>
    </div>

  </body>
</html>
